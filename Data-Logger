#include <SPI.h>
#include <Time.h>
#include <SdFat.h>
#include <SdFatUtil.h>
#include <Wire.h>
#include <Adafruit_Sensor.h>
#include <Adafruit_LSM303_U.h>
SdFat sd;
SdFile logFile;

Adafruit_LSM303_Accel_Unified accel = Adafruit_LSM303_Accel_Unified(54321);
Adafruit_LSM303_Mag_Unified mag = Adafruit_LSM303_Mag_Unified(12345);

//reduce size by making constants limited in size to thier requirements
const uint8_t chipSelect = 10;
//IMPORTANT: This value is the sample rate, and must be based on the SD card quality and it's write time
const uint8_t SAMPLE_MS = 200;
// 1 if the setup is running on a breadboard
const boolean ON_BREADBOARD =0;


uint32_t logTime;

void setup()
{
  // Open serial communications and wait for port to open:
  Serial.begin(9600);
  while (!Serial) {
    ;
  }

  Serial.println("Accelerometer Test"); Serial.println("");

  /* Initialise the sensor */
  if(!accel.begin())
  {
    /* There was a problem detecting the ADXL345 ... check your connections */
    Serial.println("Ooops, no LSM303 detected ... Check your wiring!");
    while(1);
  }

  Serial.println("Magnetometer Test"); Serial.println("");

  /* Enable auto-gain */
  mag.enableAutoRange(true);

  /* Initialise the sensor */
  if(!mag.begin())
  {
    /* There was a problem detecting the LSM303 ... check your connections */
    Serial.println("Ooops, no LSM303 detected ... Check your wiring!");
    while(1);
  }
  Serial.print("Initializing SD card...");

  // initalize SDFAT with speed dependent on if on breadboard, as Full speed
  // on breadboard or long wires can cause corruption in data
  if (!ON_BREADBOARD) {
  if(!sd.begin(chipSelect,SPI_FULL_SPEED))sd.initErrorHalt();
  } else  {
  if(!sd.begin(chipSelect,SPI_HALF_SPEED))sd.initErrorHalt();
  }

  logFile.open("datalog.csv",O_RDWR|O_CREAT|O_AT_END);// open with properties of Read/write, create if non-existant, and start at EOF
}//setup
//stores data to write in cache, to be written by .sync
void collectData() {
  sensors_event_t event;
  accel.getEvent(&event);
  mag.getEvent(&event);

   logFile.write(logTime);
   writeComma();
   logFile.write(event.acceleration.x);
   writeComma();
   logFile.write(event.acceleration.y);
   writeComma();
   logFile.write(event.acceleration.z);
   writeComma();
   logFile.write(analogRead(A0));
   writeComma();
   logFile.write(analogRead(A1));
   writeComma();
   logFile.write(analogRead(A2));
   writeComma();
   logFile.write(analogRead(A3));
   writeComma();
   logFile.write(event.magnetic.x);
   writeComma();
   logFile.write(event.magnetic.y);
   writeComma();
   logFile.write(event.magnetic.z);
   writeComma();
   logFile.write(analogRead(A4));
   logFile.write("\n");//new row
}//collectData

void writeComma() {
  logFile.write(",");
}//writeComma

void loop()
 {
   logTime += (1000UL*SAMPLE_MS);//seconds to check runtime for to prevent corruption
   int32_t elapsed;
   while(elapsed < 0) elapsed = micros()-logTime;
   //collect data



   collectData();
   logFile.sync();//wite modified data to field

 }//loop
